---
title: "Lab4"
date: "April 19, 2019"
output: html_document
---

Here is the [link](https://github.com/zeruiz/585Lab4) to our github repo

### 1. Getting data using an API

```{r, message=FALSE}
library(jsonlite)
library(tidyverse)

url <- "https://data.iowa.gov/resource/m3tr-qhgy.json?county=STORY"
story_ex <- tibble::as_tibble(fromJSON(url)) # now it's a table ready for cleaning
story_df <- data.frame(fromJSON(url)) # another option : save as dataframe 

```

### 2. Cleaning up the full dataset
Please note - here we are cleaning the large csv, found in a data folder within our working directory (but not included in the repo because of it's size). We have saved an .rda file of the cleaned dataset in our shiny folder to use with the app. 

```{r, message = FALSE, warning = FALSE}
#reading in data
dat <- readr::read_csv("data/Iowa_Liquor_Sales-Story.csv")
# making names have no spaces or parantheses
names(dat) <- stringr::str_replace_all(names(dat), "\\s","")
names(dat) <- str_remove_all(names(dat),"[\\)\\(]")

subdat <- dat %>%
  #subsetting columns of interest
  select(StoreLocation, Date, City, StoreName, VolumeSoldLiters, SaleDollars,
         CategoryName)%>%
  # separating StoreLocation into address and Lat, Lon coordinates
  separate(StoreLocation, c("Address", "Coords"),"\\(", extra = "merge")%>%
  separate(Coords, c("Lat", "Lon"), ",")%>%
  mutate(Lon = str_replace(Lon, "\\)", ""),
         Date = lubridate::mdy(Date),
         CategoryName = str_to_lower(CategoryName),
         City = str_replace(str_to_lower(City), "\\s", ""),
         Address = str_to_lower(Address),
         StoreName = str_replace(StoreName, "/.{1,}", ""),
         Year = lubridate::year(Date),
         Month = lubridate::month(Date, label = TRUE, abbr = TRUE))%>%
        # make columns into factors
  mutate_at(vars(Address, StoreName, CategoryName, City), forcats::as_factor)%>%
  mutate_at(vars(Lat, Lon), as.numeric)

# saving .rda in shiny folder 
save(subdat, file = "shiny/subdat.rda")
```

### 3. Wrking with Shiny 

```{r}
library(shiny)
require(ggplot2)
require(dplyr)
require(leaflet)
require(plotly)


# read in data
load(file = "subdat.rda")

ui <- fluidPage(
  # App Title
  titlePanel("Story County Liquor Sales"),
  
  # Sidebar #1 - date
  sidebarPanel(
      selectInput("Year", label = ("Year"),
                  choices = sort(unique(subdat$Year)),
                  selected = 2012)
    ),
  mainPanel(
    tabsetPanel(
      tabPanel("Total Sales", plotOutput(outputId = "sales")),
      tabPanel("Sales by City", plotOutput(outputId = "cities")),
      tabPanel("Store Location", leafletOutput("map1")),
      tabPanel("Store Income heat map", plotlyOutput("map2"))
      )
    )
  )

# server
server <- function(input, output){
  liq_subset <- reactive({
    subdat %>%
      filter(Year == input$Year)
  })
  city_group <- reactive({
    subdat %>%
      filter(Year == input$Year)%>%
      group_by(City, Month)%>%
      summarize(totalSales = sum(SaleDollars))
  })
  output$sales <- renderPlot({
    ggplot(data = liq_subset(), aes(x = Month, y = SaleDollars))+
      geom_col()+
      theme_bw()+
      ggtitle(paste("Total alcohol in Story County in", input$Year))
  })
  output$cities <- renderPlot({
    ggplot(data = city_group(), aes(x = Month, y = totalSales, color = City, group = City))+
      geom_point()+
      geom_line()+
      theme_bw()+
      ggtitle(paste("Total alochol sales by city in Story Count in", input$Year))
  })
  city_year <- reactive({
    subdat %>%
      filter(Year == input$Year) %>% 
      group_by(StoreName, Lon, Lat) %>% 
      summarise(income = sum(SaleDollars))
  })
  output$map1 <- renderLeaflet({
    leaflet(data = city_year()) %>% 
      addTiles() %>%
      addCircleMarkers(~Lon, ~Lat, label = ~ StoreName,
                                clusterOptions = markerClusterOptions())
  })
  output$map2 <- renderPlotly({
    p <- ggplot(data = city_year(), aes(x = Lon, y = Lat, colour = income, size=StoreName)) + 
      geom_point()+theme_bw()+theme(legend.position=c(0.8, 0.8))
    ggplotly(p)
  })
}

shinyApp(ui, server)

```

### 3. Wrking with Shiny : plot of alcohol volume purchase history in a specific year across Story County + in specific city from 2012 to 2019(another version)


#### shiny app

```{r}
library(shiny)
library(tidyverse)
library(leaflet)


# load data
load(file = "clean_data.rda")

ui <- fluidPage(
  
  # App title ----
  titlePanel("Liquor volume purchase history in Story County!"),
  
  # Sidebar layout with input and output definitions ----
  sidebarLayout(
    
    # Sidebar panel for inputs ----
    sidebarPanel(
      
      # Input: Slider for the number of bins ----
      selectInput("Year", label = ("Select Year"),
                  choices = sort(unique(sub_data$Year)),
                  selected = 2012),
      selectInput("city", label = ("Select city"),
                  choices = sort(unique(sub_data$city)),
                  selected = "ames")
      
    ),
    
    # Main panel for displaying outputs ----
    mainPanel(
      tabsetPanel(
        tabPanel("consumption by City in Year", plotOutput(outputId = "consplotyear")),
        tabPanel("Consumption of City in different year",  plotOutput(outputId = "consplotcity"))
      )
      
       )
    
  )
)

# Define server logic required to draw a histogram ----
server <- function(input, output) {
  
  liq_subset <- reactive({
    sub_data %>%
      filter(Year == input$Year)
  })
  
  liqcity_subset <- reactive({
    sub_data %>%
      filter(city == input$city)
  })
  
  # group and color plot based on the zipcode
  output$consplotyear <- renderPlot({
    ggplot(data = liq_subset(), aes(x = city, y = VolumeSoldLiters,fill=zipcode,group=zipcode))+
      geom_col()+
      ggtitle(paste("Total alcohol volume sold in Liter in Story County in", input$Year))

    
  })
  
  #group and color plot based on the day of week in every year
  output$consplotcity <- renderPlot({
    ggplot(data = liqcity_subset(), aes(x = Year, y = VolumeSoldLiters,fill = DayOfWeek,group=DayOfWeek))+
      geom_col()+
      ggtitle(paste("Total alcohol volume sold in Liter", input$city))
    
    
  })
  

}

shinyApp(ui = ui, server = server)
```


